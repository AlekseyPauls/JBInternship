<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>BotStatist</title>

    <link rel="stylesheet" href="/static/css/bootstrap.min.css">
    <link rel="stylesheet" href="/static/css/styles.css">
    <script src="/static/js/jquery.min.js"></script>
    <script src="/static/js/bootstrap.min.js"></script>

  </head>
  <body class="my-font">
    <div class="topnav">
      <a href="/">Home</a>
      <a href="/info">Info</a>
      <a href="/development" class="topnav-home">Development</a>
    </div>

    <div class="navbar-default">
      <div class="tab">
        <button class="tablinks" onclick="openTab(event, 'datasets')">Datasets</button>
        <button class="tablinks" onclick="openTab(event, 'statistics')">Statistics</button>
        <button class="tablinks" onclick="openTab(event, 'feedback')">Feedback</button>
      </div>

      <div id="datasets" class="tabcontent">
        <div class="text-center">
          <div id="datasetsList" class="tab-elem" style="min-width: 230px; height: 500px; width: 15%;">
            <div class="header-label" style="padding: 10px;">Choose dataset</div>
            <input type="text" placeholder="Search..." id="myInput1" class="form-control my-input-small" style="width: 100%;" onkeyup="filterFunction('myInput1', 'datasetsList')">
            <a id="new1" class="lang-label" style="color: #449d44; font-weight: bold;">New</a>
          </div>
          <div class="tab-elem" style="min-width: 350px; height: 500px; width: 20%;">
            <div class="header-label" style="padding: 10px;">Name</div>
            <input type="text" id="datasetName" class="form-control my-input-small">
            <div class="header-label" style="padding: 10px;">Description</div>
            <textarea id="datasetDescription" class="my-ta-small" style="height: 150px; padding: 10px;"></textarea>
            <div class="header-label" style="padding: 10px;">File</div>
            <label class="btn btn-success my-btn" style="width: 30%; float: left;">
                <input type="file" id="file1" accept="text/" class="file-input" style="display: none;">
                <span id="import1">Add file</span>
            </label>
            <input type="text" id="filename1" class="filename my-input-small" style="width: 70%; float: left;" disabled>
            <div class="header-label" style="padding: 10px; margin-top: 50px;">Actions</div>
            <div class="btn-group" style="padding: 5px;">
              <button type="button" id="saveDataset" class="btn btn-success my-btn">Save</button>
              <button type="button" id="deleteDataset" class="btn btn-primary my-btn">Delete</button>
            </div>
          </div>
          <div class="tab-elem" style="min-width: 700px; height: 500px; width: 55%;">
            <div class="header-label" style="padding: 10px;">Features</div>
            <table class="table table-striped table-bordered" style="width: 100%">
              <thead>
                <tr>
                  <th style="width: 25%; text-align: center;">Name</th>
                  <th style="width: 15%; text-align: center;">Type</th>
                  <th style="width: 45%; text-align: center;">Values</th>
                  <th style="width: 15%; text-align: center;">Action</th>
                </tr>
              </thead>
              <tbody id="tbodyFeatures">
                <tr id="newFeatureRow">
                  <td><input type="text" id="newFeatureName" class="form-control my-input-small"></td>
                  <td>
                    <button type="button" id="typeNew" class="btn btn-success my-btn">Type</button>
                  </td>
                  <td><textarea id="values" class="form-control my-ta-small"></textarea></td>
                  <td>
                    <button type="button" id="addFeature" class="btn btn-success my-btn">Add new</button>
                    <button type="button" id="importFeatures" class="btn btn-info my-btn">Import</button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div id="statistics" class="tabcontent" style="display: none;">
        <div class="text-center">
          <div id="statisticsList" class="tab-elem" style="min-width: 230px; height: 500px; width: 15%;">
            <div class="header-label" style="padding: 10px;">Choose statistic</div>
            <input type="text" placeholder="Search..." id="myInput2" class="form-control my-input-small" style="width: 100%;" onkeyup="filterFunction('myInput2', 'statisticsList')">
            <a id="new2" class="lang-label" style="color: #449d44; font-weight: bold;">New</a>
          </div>
          <div class="tab-elem" style="min-width: 350px; height: 500px; width: 20%;">
            <div class="header-label" style="padding: 10px;">Name</div>
            <input type="text" id="statisticName" class="form-control my-input-small">
            <div class="header-label" style="padding: 10px;">Description</div>
            <textarea id="statisticDescription" class="my-ta-small" style="height: 150px; padding: 10px;"></textarea>
            <div class="header-label" style="padding: 10px;">File</div>
            <label class="btn btn-success my-btn" style="width: 40%; float: left;">
                <input type="text" id="file2" accept="text/" class="file-input" style="display: none;">
                <span id="import2">Add file</span>
            </label>
            <input type="text" id="filename2" class="filename my-input-small" style="width: 60%; float: left; height: 40px;" disabled>
            <div class="header-label" style="padding: 10px; margin-top: 50px;">Actions</div>
            <div class="btn-group" style="padding: 5px;">
              <button type="button" id="saveStatistic" class="btn btn-success my-btn">Save</button>
              <button type="button" id="deleteStatistic" class="btn btn-primary my-btn">Delete</button>
            </div>
          </div>
          <div class="tab-elem" style="min-width: 700px; height: 500px; width: 55%;">
            <div class="header-label" style="padding: 10px;">Templates</div>
            <table class="table table-striped table-bordered" style="width: 100%">
              <thead>
                <tr>
                  <th style="width: 20%; text-align: center;">Question</th>
                  <th style="width: 45%; text-align: center;">Delimiters</th>
                  <th style="width: 20%; text-align: center;">Answer</th>
                  <th style="width: 15%; text-align: center;">Action</th>
                </tr>
              </thead>
              <tbody id="tbodyTemplates">
                <tr id="newTemplateRow">
                  <td><input type="text" id="newTemplateQuestion" class="form-control my-input-small"></td>
                  <td><textarea id="newTemplateDelimiters" class="form-control my-ta-small"></textarea></td>
                  <td><input type="text" id="newTemplateAnswer" class="form-control my-input-small"></td>
                  <td><button type="button" id="addTemplate" class="btn btn-success my-btn">Add new</button></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div id="feedback" class="tabcontent" style="display: none;">
        <div>In progress...</div>
      </div>
    </div>

    <div id="chooseType" class="modal fade my-font" role="dialog">
      <div class="vertical-alignment-helper">
        <div class="modal-dialog vertical-align-center">
          <div class="modal-content">
            <div id="address" style="display: none;"></div>
            <div class="header-label" style="padding: 15px;">Choose feature type</div>
            <div id="typesList" class="tab-elem modal-body" style="width: 60%; height: 150px;"></div>
            <div class="modal-footer">
              <button id="close1" type="button" class="btn btn-info my-btn" data-dismiss="modal">Close</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="importFeaturesModal" class="modal fade my-font" role="dialog">
      <div class="vertical-alignment-helper">
        <div class="modal-dialog vertical-align-center">
          <div class="modal-content">
            <div style="padding: 50px;">
              <div class="header-label" style="padding: 10px;">Choose file with features</div>
              <label class="btn btn-success my-btn" style="width: 20%; float: left;">
                  <input type="file" id="file3" accept="text/" class="file-input" style="display: none;">
                  <span id="import3">Add file</span>
              </label>
              <input type="text" id="filename3" class="filename my-input-small" style="width: 80%; float: left;" disabled>
            </div>
            <div class="modal-footer">
              <div class="btn-group" style="padding: 5px;">
                <button id="importFeaturesFromFile" type="button" class="btn btn-success my-btn" data-dismiss="modal">Import</button>
                <button id="close3" type="button" class="btn btn-info my-btn" data-dismiss="modal">Close</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="importTemplatesModal" class="modal fade my-font" role="dialog">
      <div class="vertical-alignment-helper">
        <div class="modal-dialog vertical-align-center">
          <div class="modal-content">
            <div style="padding: 50px;">
              <div class="header-label" style="padding: 10px;">Choose file with templates</div>
              <label class="btn btn-success my-btn" style="width: 20%; float: left;">
                  <input type="file" id="file4" class="file-input" accept="text/" style="display: none;">
                  <span id="import4">Add file</span>
              </label>
              <input type="text" id="filename4" class="filename my-input-small" style="width: 80%; float: left;" disabled>
            </div>
            <div class="modal-footer">
              <div class="btn-group" style="padding: 5px;">
                <button id="importTemplatesFromFile" type="button" class="btn btn-success my-btn" data-dismiss="modal">Import</button>
                <button id="close4" type="button" class="btn btn-info my-btn" data-dismiss="modal">Close</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="modal" class="modal fade my-font" role="dialog">
      <div class="vertical-alignment-helper">
        <div class="modal-dialog vertical-align-center">
          <div class="modal-content">
            <div id="message" class="modal-body message-label"></div>
            <div class="modal-footer">
              <button id="close5" type="button" class="btn btn-info" data-dismiss="modal">&nbsp;</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      var xhr = new XMLHttpRequest()

      var dataset_names = JSON.parse('{{dataset_names | safe}}')
      var statistic_names = JSON.parse('{{statistic_names | safe}}')
      var types = JSON.parse('{{types | safe}}')
      generateList(dataset_names, "datasetsList")
      generateList(statistic_names, "statisticsList")
      generateList(types, "typesList")
      $('#typeNew').text(types[0])

      xhr.onreadystatechange = function () {
        if (xhr.readyState === 4 && xhr.status === 200) {
          var json = JSON.parse(xhr.responseText)
          console.log(json)
          if (json["action"] === "setDatasetInfo") {
            setDatasetInfo(json["data"])
          } else if (json["action"] === "setStatisticInfo") {
            setStatisticInfo(json["data"])
          }
        }
      }

      $('#saveDataset').on('click', function() {


        var formData = new FormData()
        formData.append('file', document.getElementById('file1').files[0])
        formData.append("action", "saveDataset")
        xhr.open("POST", "/development", true)
        xhr.setRequestHeader("Content-Type", "application/form-data")
        xhr.send(formData)


        var name = $('#question').val()
        f = saveFeatures()
        var data = JSON.stringify({"action": "saveDataset", "name": $('#datasetName').val(),
          "description": $('#datasetDescription').val(), "features": f, "file": document.getElementById('file1').files[0]})
        xhr.open("POST", "/development", true)
        xhr.setRequestHeader("Content-Type", "application/json")
        xhr.send(data)
      })

      $(".file-input").change(function(){
       var filename = $(this).val().replace(/.*\\/, "")
       $("#filename" + this.id[4]).val(filename)
      })


      $('#typesList').on('click', 'a', function() {
        document.getElementById(document.getElementById('address').innerHTML).innerHTML = this.innerHTML
        $('#chooseType').modal('hide')
      })

      $('#datasetsList').on('click', 'a', function() {
        if (this.id == "new1") {
          $('#datasetName').val("")
          $('#datasetDescription').val("")
          $('#filename1').val("")
          var t = document.getElementById("tbodyFeatures")
          for (var i = t.childNodes.length - 1; i > -1; i--) {
            if (t.childNodes[i].id !== "newFeatureRow") {
              t.childNodes[i].remove()
            }
          }
        } else {
          getInfo("Dataset", this.innerHTML)
        }
      })

      $('#statisticsList').on('click', 'a', function() {
        if (this.id == "new2") {
          $('#statisticName').val("")
          $('#statisticDescription').val("")
          $('#filename2').val("")
          var t = document.getElementById("tbodyTemplates")
          for (var i = t.childNodes.length - 1; i > -1; i--) {
            if (t.childNodes[i].id !== "newTemplateRow") {
              t.childNodes[i].remove()
            }
          }
        } else {
          getInfo("Statistic", this.innerHTML)
        }
      })

      $('#tbodyFeatures').on('click', 'button', function() {
        if (this.innerHTML === "Delete") {
          this.parentNode.parentNode.remove()
        } else if (this.innerHTML === "Add new") {
          createFeatureRow($('#newFeatureName').val(), $('#typeNew').text(), $('#values').val())
        } else if (this.innerHTML === "Import") {
          $('#importFeaturesModal').modal('show')
        } else {
          document.getElementById('address').innerHTML = this.id
          $('#chooseType').modal('show')
        }
      })

      $('#tbodyTemplates').on('click', 'button', function() {
        if (this.innerHTML === "Delete") {
          this.parentNode.parentNode.remove()
        } else if (this.innerHTML === "Add new") {
          createTemplateRow($('#newTemplateQuestion').val(), $('#newTemplateDelimiters').val(), $('#newTemplateAnswer').val())
        }
      })

      function generateList(list, place) {
        for (var i = 0; i < list.length; i++) {
          var listElem = document.createElement("a")
          listElem.innerHTML = list[i]
          listElem.className = "lang-label"
          document.getElementById(place).appendChild(listElem)
        }
      }

      function getInfo(obj, name) {
        var data = JSON.stringify({"action": "get" + obj + "Info", "name": name})
        xhr.open("POST", "/development", true)
        xhr.setRequestHeader("Content-Type", "application/json");
        xhr.send(data)
      }

      function saveFeatures() {
        var f = []
        var tbody = document.getElementById("tbodyFeatures")
        for (var i = 1; i < tbody.childNodes.length; i++) {
          var values = []
          var vals = tbody.childNodes[i].querySelector("textarea").value.split("\"\n")
          for (var j = 0; j < vals.length; j++) {
            if (j + 1 === vals.length) {
              values.push(vals[j].slice(1, -1))
            } else if (vals[j] !== "") {
              values.push(vals[j].slice(1, vals[j].length))
            }
          }
          f.push({"name": tbody.childNodes[i].querySelector("input").value,
                  "type": tbody.childNodes[i].querySelector("button").innerHTML,
                  "values": values
                  })
        }
        return f
      }

      function setDatasetInfo(data) {
        $('#datasetName').val(data["name"])
        $('#datasetDescription').val(data["description"])
        $('#filename1').val(data["file"])
        var t = document.getElementById("tbodyFeatures")
        for (var i = t.childNodes.length - 1; i > -1; i--) {
          if (t.childNodes[i].id !== "newFeatureRow") {
            t.childNodes[i].remove()
          }
        }
        for (var i = 0; i < data["features"].length; i++) {
          var s = ""
          for (var j = 0; j < data["features"][i]["values"].length; j++) {
            s += "\"" + data["features"][i]["values"][j] + "\"\n"
          }
          s = s.slice(0, -1)
          createFeatureRow(data["features"][i]["name"], data["features"][i]["type"], s)
        }
      }

      function setStatisticInfo(data) {
        $('#statisticName').val(data["name"])
        $('#statisticDescription').val(data["description"])
        $('#filename2').val(data["file"])
        var t = document.getElementById("tbodyTemplates")
        for (var i = t.childNodes.length - 1; i > -1; i--) {
          if (t.childNodes[i].id !== "newTemplateRow") {
            t.childNodes[i].remove()
          }
        }
        for (var i = 0; i < data["templates"].length; i++) {
          var s = ""
          for (var j = 0; j < data["templates"][i]["delimiters"].length; j++) {
            s += "\"" + data["templates"][i]["delimiters"][j] + "\"\n"
          }
          s = s.slice(0, -1)
          createTemplateRow("\"" + data["templates"][i]["question"] + "\"", s, "\"" + data["templates"][i]["answer"] + "\"")
        }
      }

      function createFeatureRow(name, type, values) {
        var tb = document.getElementById("tbodyFeatures")
        var row = document.createElement("tr")

        var td1 = document.createElement("td")
        var in1 = document.createElement("input")
        in1.setAttribute("class", "form-control my-input-small")
        in1.setAttribute("type", "text")
        in1.setAttribute("value", name)
        td1.appendChild(in1)

        var td2 = document.createElement("td")
        var b2 = document.createElement("button")
        b2.setAttribute("type", "button")
        b2.setAttribute("class", "btn btn-success my-btn")
        b2.innerHTML = type
        b2.setAttribute("id", "type" + (tb.childNodes.length + 1))
        td2.appendChild(b2)

        var td3 = document.createElement("td")
        var ta3 = document.createElement("textarea")
        ta3.setAttribute("class", "form-control my-ta-small")
        ta3.innerHTML = values
        td3.appendChild(ta3)

        var td4 = document.createElement("td")
        var b4 = document.createElement("button")
        b4.setAttribute("type", "button")
        b4.setAttribute("class", "btn btn-success my-btn")
        b4.innerHTML = "Delete"
        td4.appendChild(b4)

        row.appendChild(td1)
        row.appendChild(td2)
        row.appendChild(td3)
        row.appendChild(td4)
        tb.appendChild(row)
      }

      function createTemplateRow(question, delimiters, answer) {
        var tb = document.getElementById("tbodyTemplates")
        var row = document.createElement("tr")

        var td1 = document.createElement("td")
        var in1 = document.createElement("input")
        in1.setAttribute("class", "form-control my-input-small")
        in1.setAttribute("type", "text")
        in1.setAttribute("value", question)
        td1.appendChild(in1)

        var td2 = document.createElement("td")
        var ta2 = document.createElement("textarea")
        ta2.setAttribute("class", "form-control my-ta-small")
        ta2.innerHTML = delimiters
        td2.appendChild(ta2)

        var td3 = document.createElement("td")
        var in3 = document.createElement("input")
        in3.setAttribute("class", "form-control my-input-small")
        in3.setAttribute("type", "text")
        in3.setAttribute("value", answer)
        td3.appendChild(in3)

        var td4 = document.createElement("td")
        var b4 = document.createElement("button")
        b4.setAttribute("type", "button")
        b4.setAttribute("class", "btn btn-success my-btn")
        b4.innerHTML = "Delete"
        td4.appendChild(b4)

        row.appendChild(td1)
        row.appendChild(td2)
        row.appendChild(td3)
        row.appendChild(td4)
        tb.appendChild(row)
      }

      function openTab(evt, tabName) {
        var i, tabcontent, tablinks;
        tabcontent = document.getElementsByClassName("tabcontent")
        for (i = 0; i < tabcontent.length; i++) {
            tabcontent[i].style.display = "none"
        }
        tablinks = document.getElementsByClassName("tablinks")
        for (i = 0; i < tablinks.length; i++) {
            tablinks[i].className = tablinks[i].className.replace(" active", "")
        }
        document.getElementById(tabName).style.display = "block"
        evt.currentTarget.className += " active"
      }

      function showHide() {
        document.getElementById("typesList").classList.toggle("show")
      }

      function filterFunction(inp, outp) {
        var input, filter, a, i, div
        input = document.getElementById(inp)
        filter = input.value.toUpperCase()
        div = document.getElementById(outp)
        a = div.getElementsByTagName("a")
        for (i = 0; i < a.length; i++) {
          if (a[i].innerHTML.toUpperCase().indexOf(filter) > -1) {
            a[i].style.display = ""
          } else {
            a[i].style.display = "none"
          }
        }
      }
    </script>
  </body>
</html>